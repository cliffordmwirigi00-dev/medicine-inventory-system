<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Inventory Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px 20px; text-align: center; }
        .header-image { width: 180px; height: 180px; border-radius: 20px; object-fit: cover; border: 5px solid #3498db; box-shadow: 0 8px 25px rgba(0,0,0,0.3); margin: 0 auto 20px auto; display: block; background: white; padding: 5px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; max-width: 600px; margin: 0 auto; line-height: 1.6; }
        .nav { background: #34495e; padding: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; border-bottom: 3px solid #3498db; }
        .nav-btn { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); }
        .nav-btn.active { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .content { padding: 30px; min-height: 600px; background: #f8f9fa; }
        .section { display: none; animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); text-align: center; border-top: 5px solid #3498db; transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.warning { border-top-color: #f39c12; }
        .stat-card.danger { border-top-color: #e74c3c; }
        .stat-card.expired { border-top-color: #7f8c8d; }
        .stat-number { font-size: 2.8em; font-weight: bold; margin: 15px 0; color: #2c3e50; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 15px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .btn { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; margin: 5px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-danger:hover { box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #219a52 100%); }
        .btn-success:hover { box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-warning:hover { box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4); }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        th { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; font-weight: 600; font-size: 14px; }
        tr:hover { background: #f8f9fa; transform: scale(1.01); transition: transform 0.2s ease; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-normal { background: #d4edda; color: #155724; }
        .status-low_stock { background: #fff3cd; color: #856404; }
        .status-expiring_soon { background: #f8d7da; color: #721c24; }
        .status-expired { background: #d6d8d9; color: #1b1e21; }
        .alert { padding: 18px; margin: 15px 0; border-radius: 8px; border-left: 5px solid; font-weight: 500; }
        .alert-warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .alert-danger { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 3% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .close { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: #7f8c8d; transition: color 0.3s ease; }
        .close:hover { color: #e74c3c; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-form { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 450px; text-align: center; }
        .form-actions { display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px; }
        .search-filter { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: end; }
        .search-filter input, .search-filter select { padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 15px; flex: 1; min-width: 200px; }
        .sales-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; padding: 25px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sales-form .form-group { margin-bottom: 0; }
        .discount-section { background: #fff3cd; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f39c12; }
        .price-breakdown { background: #e8f4fd; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #3498db; }
        .price-item { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; border-bottom: 1px solid rgba(52, 152, 219, 0.1); }
        .price-total { font-weight: bold; border-top: 2px solid #3498db; padding-top: 10px; margin-top: 15px; font-size: 1.1em; color: #2c3e50; }
        .medicine-image { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; border: 2px solid #e1e8ed; transition: transform 0.3s ease; }
        .medicine-image:hover { transform: scale(1.1); }
        .medicine-image-large { width: 150px; height: 150px; border-radius: 12px; object-fit: cover; border: 4px solid #3498db; margin: 15px 0; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
        .image-upload { border: 3px dashed #bdc3c7; padding: 30px; text-align: center; border-radius: 10px; cursor: pointer; margin: 15px 0; transition: all 0.3s ease; background: #f8f9fa; }
        .image-upload:hover { border-color: #3498db; background: #e8f4fd; }
        .sales-summary { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 20px; border-radius: 10px; margin: 15px 0; box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .notification { position: fixed; top: 30px; right: 30px; padding: 18px 25px; border-radius: 10px; color: white; font-weight: 600; z-index: 1001; animation: slideIn 0.4s ease; box-shadow: 0 8px 25px rgba(0,0,0,0.3); min-width: 300px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification.success { background: linear-gradient(135deg, #27ae60 0%, #219a52 100%); }
        .notification.error { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .notification.warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .edit-sale-form { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 5px solid #3498db; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .section-title { font-size: 2em; color: #2c3e50; margin-bottom: 25px; text-align: center; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        @media (max-width: 768px) { .nav { flex-direction: column; } .nav-btn { width: 100%; margin: 5px 0; } .stats-grid { grid-template-columns: 1fr; } .sales-form { grid-template-columns: 1fr; } .search-filter { flex-direction: column; } .header h1 { font-size: 2em; } .header-image { width: 140px; height: 140px; } }
        @media (max-width: 480px) { .content { padding: 15px; } .header { padding: 20px 15px; } .header-image { width: 120px; height: 120px; } .header h1 { font-size: 1.8em; } }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h2 style="margin-bottom: 30px; color: #2c3e50; font-size: 1.8em;">ğŸ’Š Medicine Inventory System</h2>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" value="admin" style="text-align: center;">
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" value="admin123" style="text-align: center;">
            </div>
            <button onclick="login()" class="btn" style="width: 100%; margin-top: 20px; padding: 15px;">ğŸ” Login to System</button>
            <div style="margin-top: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px; font-size: 13px;">
                <strong>Default Login Credentials:</strong><br>ğŸ‘¤ Username: admin<br>ğŸ”‘ Password: admin123
            </div>
        </div>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="header">
            <img src="https://images.unsplash.com/photo-1587854692152-cbe660dbde88?w=300&h=300&fit=crop&crop=center&auto=format" alt="Pharmacy Medicine" class="header-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0xMDAgMTIwSDE4MFYxODBIMTAwVjEyMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0xMjAgMTAwVjIwME0xNjAgMTAwVjIwMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI4Ii8+Cjx0ZXh0IHg9IjE1MCIgeT0iMjQwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyNCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIj7imqMgTWVkaWNpbmU8L3RleHQ+Cjwvc3ZnPgo='">
            <div class="header-content">
                <h1>ğŸ’Š Medicine Inventory Management System</h1>
                <p>Comprehensive Inventory Solution - Track, Manage, and Prevent Expired Medicine Sales</p>
            </div>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">ğŸ“Š Dashboard</button>
            <button class="nav-btn" onclick="showSection('medicines')">ğŸ’Š Medicines</button>
            <button class="nav-btn" onclick="showSection('sales')">ğŸ’° Sales</button>
            <button class="nav-btn" onclick="showSection('reports')">ğŸ“ˆ Reports</button>
            <button class="nav-btn btn-danger" onclick="logout()">ğŸšª Logout</button>
        </div>

        <div class="content">
            <div id="dashboard" class="section active">
                <h2 class="section-title">ğŸ“Š System Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>ğŸ“¦ Total Medicines</h3><div class="stat-number" id="totalMedicines">0</div><p>All registered medicines in inventory</p></div>
                    <div class="stat-card warning"><h3>âš ï¸ Low Stock</h3><div class="stat-number" id="lowStock">0</div><p>Below minimum stock level</p></div>
                    <div class="stat-card danger"><h3>â° Expiring Soon</h3><div class="stat-number" id="expiringSoon">0</div><p>Expiring within 30 days</p></div>
                    <div class="stat-card expired"><h3>ğŸš« Expired</h3><div class="stat-number" id="expired">0</div><p>Past expiry date - Remove immediately</p></div>
                </div>
                <h3 style="color: #2c3e50; margin: 30px 0 15px 0;">ğŸ”” Recent Alerts & Notifications</h3>
                <div id="alertsContainer"></div>
            </div>

            <div id="medicines" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 class="section-title">ğŸ’Š Medicine Management</h2>
                    <button class="btn btn-success" onclick="showMedicineForm()">â• Add New Medicine</button>
                </div>
                <div class="search-filter">
                    <input type="text" id="searchMedicine" placeholder="ğŸ” Search medicines by name or batch number..." style="flex: 2;">
                    <select id="statusFilter">
                        <option value="all">ğŸ“‹ All Status</option>
                        <option value="normal">âœ… Normal</option>
                        <option value="low_stock">âš ï¸ Low Stock</option>
                        <option value="expiring_soon">â° Expiring Soon</option>
                        <option value="expired">ğŸš« Expired</option>
                    </select>
                    <button class="btn" onclick="filterMedicines()">ğŸ” Search</button>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ–¼ï¸ Image</th><th>ğŸ’Š Name</th><th>ğŸ·ï¸ Batch No.</th><th>ğŸ“¦ Quantity</th><th>ğŸ’° Price</th><th>ğŸ“… Expiry Date</th><th>âš¡ Min Stock</th><th>ğŸ“Š Status</th><th>âš™ï¸ Actions</th>
                            </tr>
                        </thead>
                        <tbody id="medicinesTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="sales" class="section">
                <h2 class="section-title">ğŸ’° Sales Management</h2>
                <div class="sales-form">
                    <div class="form-group"><label for="saleMedicine">ğŸ’Š Select Medicine:</label><select id="saleMedicine" onchange="updateSalePrice()"><option value="">-- Select Medicine --</option></select></div>
                    <div class="form-group"><label for="saleQuantity">ğŸ“¦ Quantity:</label><input type="number" id="saleQuantity" min="1" value="1" onchange="updateSalePrice()"></div>
                    <div class="form-group"><label for="saleDiscount">ğŸ¯ Discount (%):</label><input type="number" id="saleDiscount" min="0" max="100" value="0" onchange="updateSalePrice()"></div>
                    <div class="form-group"><label for="salePrice">ğŸ’° Unit Price:</label><input type="number" id="salePrice" step="0.01" min="0" readonly style="background: #f8f9fa;"></div>
                </div>
                <div class="price-breakdown" id="priceBreakdown"></div>
                <div class="form-actions">
                    <button class="btn btn-success" onclick="recordSale()">ğŸ’° Record Sale</button>
                    <button class="btn" onclick="clearSaleForm()">ğŸ—‘ï¸ Clear Form</button>
                </div>
                <h3 style="color: #2c3e50; margin: 40px 0 20px 0;">ğŸ“‹ Recent Sales Transactions</h3>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ğŸ’Š Medicine</th><th>ğŸ–¼ï¸ Image</th><th>ğŸ“¦ Quantity</th><th>ğŸ’° Unit Price</th><th>ğŸ¯ Discount</th><th>ğŸ’µ Total</th><th>ğŸ“… Date</th><th>âš™ï¸ Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salesTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="reports" class="section">
                <h2 class="section-title">ğŸ“ˆ Analytics & Reports</h2>
                <div style="margin-bottom: 30px; text-align: center;">
                    <button class="btn" onclick="generateExpiryReport()">â° Expiry Report</button>
                    <button class="btn" onclick="generateStockReport()">ğŸ“¦ Stock Report</button>
                    <button class="btn" onclick="generateSalesReport()">ğŸ’° Sales Report</button>
                    <button class="btn" onclick="generateDiscountReport()">ğŸ¯ Discount Analysis</button>
                </div>
                <div id="reportsOutput" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 400px;"></div>
            </div>
        </div>
    </div>

    <div id="medicineModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMedicineForm()">&times;</span>
            <h3 id="medicineFormTitle" style="color: #2c3e50; margin-bottom: 25px;">ğŸ’Š Add New Medicine</h3>
            <div class="form-group">
                <label>ğŸ–¼ï¸ Medicine Image:</label>
                <div class="image-upload" onclick="document.getElementById('medicineImageInput').click()">
                    <p style="margin-bottom: 10px; font-size: 16px; color: #7f8c8d;">ğŸ“ Click to upload medicine image</p>
                    <img id="medicineImagePreview" class="medicine-image-large" src="https://images.unsplash.com/photo-1587854692152-cbe660dbde88?w=200&h=200&fit=crop&crop=center&auto=format" alt="Medicine Preview">
                </div>
                <input type="file" id="medicineImageInput" accept="image/*" style="display: none;" onchange="previewMedicineImage(event)">
            </div>
            <div class="form-group"><label for="medicineName">ğŸ’Š Medicine Name:</label><input type="text" id="medicineName" required placeholder="Enter medicine name"></div>
            <div class="form-group"><label for="batchNumber">ğŸ·ï¸ Batch Number:</label><input type="text" id="batchNumber" required placeholder="Enter batch number"></div>
            <div class="form-group"><label for="quantity">ğŸ“¦ Quantity:</label><input type="number" id="quantity" min="0" required placeholder="Enter quantity"></div>
            <div class="form-group"><label for="price">ğŸ’° Price:</label><input type="number" id="price" step="0.01" min="0" required placeholder="Enter price"></div>
            <div class="form-group"><label for="expiryDate">ğŸ“… Expiry Date:</label><input type="date" id="expiryDate" required></div>
            <div class="form-group"><label for="minStock">âš¡ Minimum Stock Level:</label><input type="number" id="minStock" min="1" value="10" required></div>
            <div class="form-group"><label for="medicineDescription">ğŸ“ Description:</label><textarea id="medicineDescription" rows="3" placeholder="Optional medicine description"></textarea></div>
            <div class="form-actions">
                <button class="btn btn-success" onclick="saveMedicine()">ğŸ’¾ Save Medicine</button>
                <button class="btn btn-danger" onclick="closeMedicineForm()">âŒ Cancel</button>
            </div>
        </div>
    </div>

    <div id="editSaleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditSaleForm()">&times;</span>
            <h3 style="color: #2c3e50; margin-bottom: 25px;">âœï¸ Edit Sale Record</h3>
            <div class="edit-sale-form">
                <div class="form-group"><label for="editSaleMedicine">ğŸ’Š Medicine:</label><select id="editSaleMedicine" onchange="updateEditSalePrice()"><option value="">-- Select Medicine --</option></select></div>
                <div class="form-group"><label for="editSaleQuantity">ğŸ“¦ Quantity:</label><input type="number" id="editSaleQuantity" min="1" value="1" onchange="updateEditSalePrice()"></div>
                <div class="form-group"><label for="editSaleDiscount">ğŸ¯ Discount (%):</label><input type="number" id="editSaleDiscount" min="0" max="100" value="0" onchange="updateEditSalePrice()"></div>
                <div class="form-group"><label for="editSalePrice">ğŸ’° Unit Price:</label><input type="number" id="editSalePrice" step="0.01" min="0"></div>
                <div class="price-breakdown" id="editPriceBreakdown"></div>
            </div>
            <div class="form-actions">
                <button class="btn btn-success" onclick="updateSale()">ğŸ’¾ Update Sale</button>
                <button class="btn btn-danger" onclick="closeEditSaleForm()">âŒ Cancel</button>
            </div>
        </div>
    </div>

    <script>
        class MedicineDB {
            constructor() { this.initDB(); }
            initDB() {
                if (!localStorage.getItem('medicine_users')) {
                    localStorage.setItem('medicine_users', JSON.stringify([{ id: 1, username: 'admin', password: 'admin123', full_name: 'System Administrator' }]));
                }
                if (!localStorage.getItem('medicine_medicines')) {
                    const sampleMedicines = [
                        { id: 1, name: 'Paracetamol 500mg', batch_number: 'BATCH001', quantity: 50, price: 5.00, expiry_date: '2025-06-15', min_stock: 20, image: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Pain reliever and fever reducer', created_at: new Date().toISOString() },
                        { id: 2, name: 'Amoxicillin 250mg', batch_number: 'BATCH002', quantity: 8, price: 15.50, expiry_date: '2024-12-20', min_stock: 15, image: 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Antibiotic for bacterial infections', created_at: new Date().toISOString() },
                        { id: 3, name: 'Ibuprofen 400mg', batch_number: 'BATCH003', quantity: 30, price: 8.75, expiry_date: '2024-11-30', min_stock: 10, image: 'https://images.unsplash.com/photo-1585435557343-3b092031d5ad?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Anti-inflammatory pain reliever', created_at: new Date().toISOString() },
                        { id: 4, name: 'Vitamin C 1000mg', batch_number: 'BATCH004', quantity: 25, price: 12.00, expiry_date: '2025-03-20', min_stock: 15, image: 'https://images.unsplash.com/photo-1550572017-2c6d4b4c6d8a?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Immune system booster', created_at: new Date().toISOString() },
                        { id: 5, name: 'Cetirizine 10mg', batch_number: 'BATCH005', quantity: 5, price: 7.50, expiry_date: '2024-10-15', min_stock: 10, image: 'https://images.unsplash.com/photo-1599045118108-bf9954418b76?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Antihistamine for allergies', created_at: new Date().toISOString() },
                        { id: 6, name: 'Aspirin 100mg', batch_number: 'BATCH006', quantity: 40, price: 4.50, expiry_date: '2025-05-10', min_stock: 20, image: 'https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Pain reliever and anti-inflammatory', created_at: new Date().toISOString() },
                        { id: 7, name: 'Metformin 500mg', batch_number: 'BATCH007', quantity: 60, price: 9.25, expiry_date: '2025-07-22', min_stock: 30, image: 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Diabetes medication', created_at: new Date().toISOString() },
                        { id: 8, name: 'Omeprazole 20mg', batch_number: 'BATCH008', quantity: 35, price: 11.75, expiry_date: '2025-01-30', min_stock: 15, image: 'https://images.unsplash.com/photo-1585435557343-3b092031d5ad?w=200&h=200&fit=crop&crop=center&auto=format', description: 'Acid reducer', created_at: new Date().toISOString() }
                    ];
                    localStorage.setItem('medicine_medicines', JSON.stringify(sampleMedicines));
                }
                if (!localStorage.getItem('medicine_sales')) {
                    localStorage.setItem('medicine_sales', JSON.stringify([]));
                }
            }
            getUser(username, password) {
                const users = JSON.parse(localStorage.getItem('medicine_users') || '[]');
                return users.find(u => u.username === username && u.password === password);
            }
            getMedicines() { return JSON.parse(localStorage.getItem('medicine_medicines') || '[]'); }
            saveMedicine(medicine) {
                const medicines = this.getMedicines();
                if (medicine.id) {
                    const index = medicines.findIndex(m => m.id === medicine.id);
                    if (index !== -1) medicines[index] = medicine;
                } else {
                    medicine.id = Date.now();
                    medicine.created_at = new Date().toISOString();
                    if (!medicine.image) medicine.image = 'https://images.unsplash.com/photo-1587854692152-cbe660dbde88?w=200&h=200&fit=crop&crop=center&auto=format';
                    medicines.push(medicine);
                }
                localStorage.setItem('medicine_medicines', JSON.stringify(medicines));
                return medicine;
            }
            deleteMedicine(id) {
                const medicines = this.getMedicines().filter(m => m.id !== id);
                localStorage.setItem('medicine_medicines', JSON.stringify(medicines));
            }
            getSales() { return JSON.parse(localStorage.getItem('medicine_sales') || '[]'); }
            recordSale(sale) {
                const sales = this.getSales();
                sale.id = Date.now();
                sale.date = new Date().toISOString();
                sales.push(sale);
                localStorage.setItem('medicine_sales', JSON.stringify(sales));
                const medicines = this.getMedicines();
                const medicine = medicines.find(m => m.id === sale.medicine_id);
                if (medicine) {
                    medicine.quantity -= sale.quantity;
                    this.saveMedicine(medicine);
                }
            }
            updateSale(saleId, updatedSale) {
                const sales = this.getSales();
                const saleIndex = sales.findIndex(s => s.id === saleId);
                if (saleIndex !== -1) {
                    const originalSale = sales[saleIndex];
                    const medicines = this.getMedicines();
                    const medicine = medicines.find(m => m.id === originalSale.medicine_id);
                    if (medicine) medicine.quantity += originalSale.quantity;
                    updatedSale.id = saleId;
                    updatedSale.date = originalSale.date;
                    sales[saleIndex] = updatedSale;
                    const newMedicine = medicines.find(m => m.id === updatedSale.medicine_id);
                    if (newMedicine) newMedicine.quantity -= updatedSale.quantity;
                    localStorage.setItem('medicine_medicines', JSON.stringify(medicines));
                    localStorage.setItem('medicine_sales', JSON.stringify(sales));
                    return true;
                }
                return false;
            }
            deleteSale(saleId) {
                const sales = this.getSales();
                const saleIndex = sales.findIndex(s => s.id === saleId);
                if (saleIndex !== -1) {
                    const sale = sales[saleIndex];
                    const medicines = this.getMedicines();
                    const medicine = medicines.find(m => m.id === sale.medicine_id);
                    if (medicine) {
                        medicine.quantity += sale.quantity;
                        localStorage.setItem('medicine_medicines', JSON.stringify(medicines));
                    }
                    sales.splice(saleIndex, 1);
                    localStorage.setItem('medicine_sales', JSON.stringify(sales));
                    return true;
                }
                return false;
            }
        }

        const db = new MedicineDB();
        let currentUser = null;
        let currentEditingMedicine = null;
        let currentEditingSale = null;

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = db.getUser(username, password);
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                loadDashboard();
                showNotification('ğŸ‰ Login successful! Welcome to the Medicine Management System', 'success');
            } else {
                showNotification('âŒ Invalid username or password! Please try again.', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
            showNotification('ğŸ‘‹ Logged out successfully!', 'success');
        }

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
            switch(sectionName) {
                case 'dashboard': loadDashboard(); break;
                case 'medicines': loadMedicines(); break;
                case 'sales': loadSales(); loadMedicineOptions(); updateSalePrice(); break;
                case 'reports': loadReports(); break;
            }
        }

        function loadDashboard() {
            const medicines = db.getMedicines();
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            const stats = {
                total: medicines.length,
                lowStock: medicines.filter(m => m.quantity <= m.min_stock).length,
                expiringSoon: medicines.filter(m => { const expiry = new Date(m.expiry_date); return expiry > now && expiry <= thirtyDaysFromNow; }).length,
                expired: medicines.filter(m => new Date(m.expiry_date) <= now).length
            };
            document.getElementById('totalMedicines').textContent = stats.total;
            document.getElementById('lowStock').textContent = stats.lowStock;
            document.getElementById('expiringSoon').textContent = stats.expiringSoon;
            document.getElementById('expired').textContent = stats.expired;
            loadAlerts();
        }

        function loadAlerts() {
            const medicines = db.getMedicines();
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            const alertsContainer = document.getElementById('alertsContainer');
            alertsContainer.innerHTML = '';
            medicines.forEach(medicine => {
                const expiryDate = new Date(medicine.expiry_date);
                let alert = null;
                if (expiryDate <= now) {
                    alert = { type: 'danger', message: `ğŸš¨ EXPIRED: ${medicine.name} (Batch: ${medicine.batch_number}) expired on ${expiryDate.toLocaleDateString()} - REMOVE IMMEDIATELY` };
                } else if (expiryDate <= thirtyDaysFromNow) {
                    alert = { type: 'warning', message: `âš ï¸ EXPIRING SOON: ${medicine.name} (Batch: ${medicine.batch_number}) expires on ${expiryDate.toLocaleDateString()} - ${Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24))} days left` };
                } else if (medicine.quantity <= medicine.min_stock) {
                    alert = { type: 'warning', message: `ğŸ“‰ LOW STOCK: ${medicine.name} has only ${medicine.quantity} units left (minimum: ${medicine.min_stock}) - REORDER NEEDED` };
                }
                if (alert) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-${alert.type}`;
                    alertDiv.textContent = alert.message;
                    alertsContainer.appendChild(alertDiv);
                }
            });
            if (alertsContainer.children.length === 0) {
                alertsContainer.innerHTML = '<div class="alert" style="background: #d4edda; color: #155724; border-color: #c3e6cb;">âœ… No alerts at this time. All medicines are in good condition and properly stocked.</div>';
            }
        }

        function loadMedicines() {
            const medicines = db.getMedicines();
            const tbody = document.getElementById('medicinesTable');
            tbody.innerHTML = '';
            medicines.forEach(medicine => {
                const status = getMedicineStatus(medicine);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${medicine.image}" alt="${medicine.name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyMFY2ME00MCAyMFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                    <td><strong>${medicine.name}</strong>${medicine.description ? '<br><small style=\"color:#7f8c8d;\">' + medicine.description + '</small>' : ''}</td>
                    <td>${medicine.batch_number}</td>
                    <td>${medicine.quantity}</td>
                    <td>$${parseFloat(medicine.price).toFixed(2)}</td>
                    <td>${new Date(medicine.expiry_date).toLocaleDateString()}</td>
                    <td>${medicine.min_stock}</td>
                    <td><span class="status-badge status-${status}">${status.replace('_', ' ').toUpperCase()}</span></td>
                    <td>
                        <button class="btn" onclick="editMedicine(${medicine.id})">âœï¸ Edit</button>
                        <button class="btn btn-danger" onclick="deleteMedicine(${medicine.id})">ğŸ—‘ï¸ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getMedicineStatus(medicine) {
            const now = new Date();
            const expiryDate = new Date(medicine.expiry_date);
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            if (expiryDate <= now) return 'expired';
            if (expiryDate <= thirtyDaysFromNow) return 'expiring_soon';
            if (medicine.quantity <= medicine.min_stock) return 'low_stock';
            return 'normal';
        }

        function showMedicineForm(medicine = null) {
            currentEditingMedicine = medicine;
            const modal = document.getElementById('medicineModal');
            const title = document.getElementById('medicineFormTitle');
            if (medicine) {
                title.textContent = 'âœï¸ Edit Medicine';
                document.getElementById('medicineName').value = medicine.name;
                document.getElementById('batchNumber').value = medicine.batch_number;
                document.getElementById('quantity').value = medicine.quantity;
                document.getElementById('price').value = medicine.price;
                document.getElementById('expiryDate').value = medicine.expiry_date;
                document.getElementById('minStock').value = medicine.min_stock;
                document.getElementById('medicineDescription').value = medicine.description || '';
                document.getElementById('medicineImagePreview').src = medicine.image;
            } else {
                title.textContent = 'ğŸ’Š Add New Medicine';
                document.getElementById('medicineName').value = '';
                document.getElementById('batchNumber').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('price').value = '';
                document.getElementById('expiryDate').value = '';
                document.getElementById('minStock').value = '10';
                document.getElementById('medicineDescription').value = '';
                document.getElementById('medicineImagePreview').src = 'https://images.unsplash.com/photo-1587854692152-cbe660dbde88?w=200&h=200&fit=crop&crop=center&auto=format';
            }
            modal.style.display = 'block';
        }

        function closeMedicineForm() {
            document.getElementById('medicineModal').style.display = 'none';
            currentEditingMedicine = null;
        }

        function previewMedicineImage(event) {
            const input = event.target;
            const preview = document.getElementById('medicineImagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { preview.src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveMedicine() {
            const formData = {
                name: document.getElementById('medicineName').value,
                batch_number: document.getElementById('batchNumber').value,
                quantity: parseInt(document.getElementById('quantity').value),
                price: parseFloat(document.getElementById('price').value),
                expiry_date: document.getElementById('expiryDate').value,
                min_stock: parseInt(document.getElementById('minStock').value),
                description: document.getElementById('medicineDescription').value,
                image: document.getElementById('medicineImagePreview').src
            };
            if (currentEditingMedicine) {
                formData.id = currentEditingMedicine.id;
                formData.created_at = currentEditingMedicine.created_at;
                formData.image = formData.image || currentEditingMedicine.image;
            }
            db.saveMedicine(formData);
            closeMedicineForm();
            loadMedicines();
            loadDashboard();
            showNotification('âœ… Medicine saved successfully!', 'success');
        }

        function editMedicine(id) {
            const medicine = db.getMedicines().find(m => m.id === id);
            if (medicine) showMedicineForm(medicine);
        }

        function deleteMedicine(id) {
            if (confirm('âš ï¸ Are you sure you want to delete this medicine? This action cannot be undone.')) {
                db.deleteMedicine(id);
                loadMedicines();
                loadDashboard();
                showNotification('ğŸ—‘ï¸ Medicine deleted successfully!', 'success');
            }
        }

        function filterMedicines() {
            const searchTerm = document.getElementById('searchMedicine').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const medicines = db.getMedicines();
            let filtered = medicines.filter(medicine => 
                medicine.name.toLowerCase().includes(searchTerm) ||
                medicine.batch_number.toLowerCase().includes(searchTerm) ||
                (medicine.description && medicine.description.toLowerCase().includes(searchTerm))
            );
            if (statusFilter !== 'all') {
                filtered = filtered.filter(medicine => getMedicineStatus(medicine) === statusFilter);
            }
            const tbody = document.getElementById('medicinesTable');
            tbody.innerHTML = '';
            filtered.forEach(medicine => {
                const status = getMedicineStatus(medicine);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${medicine.image}" alt="${medicine.name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyMFY2ME00MCAyMFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                    <td><strong>${medicine.name}</strong>${medicine.description ? '<br><small style=\"color:#7f8c8d;\">' + medicine.description + '</small>' : ''}</td>
                    <td>${medicine.batch_number}</td>
                    <td>${medicine.quantity}</td>
                    <td>$${parseFloat(medicine.price).toFixed(2)}</td>
                    <td>${new Date(medicine.expiry_date).toLocaleDateString()}</td>
                    <td>${medicine.min_stock}</td>
                    <td><span class="status-badge status-${status}">${status.replace('_', ' ').toUpperCase()}</span></td>
                    <td>
                        <button class="btn" onclick="editMedicine(${medicine.id})">âœï¸ Edit</button>
                        <button class="btn btn-danger" onclick="deleteMedicine(${medicine.id})">ğŸ—‘ï¸ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadMedicineOptions() {
            const select = document.getElementById('saleMedicine');
            const editSelect = document.getElementById('editSaleMedicine');
            select.innerHTML = '<option value="">-- Select Medicine --</option>';
            editSelect.innerHTML = '<option value="">-- Select Medicine --</option>';
            const medicines = db.getMedicines().filter(medicine => medicine.quantity > 0 && new Date(medicine.expiry_date) > new Date());
            medicines.forEach(medicine => {
                const option = document.createElement('option');
                option.value = medicine.id;
                option.textContent = `${medicine.name} (Stock: ${medicine.quantity}, Price: $${medicine.price})`;
                option.setAttribute('data-price', medicine.price);
                select.appendChild(option);
                const editOption = option.cloneNode(true);
                editSelect.appendChild(editOption);
            });
        }

        function updateSalePrice() {
            const medicineId = document.getElementById('saleMedicine').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 1;
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            if (medicineId) {
                const medicine = db.getMedicines().find(m => m.id === parseInt(medicineId));
                if (medicine) {
                    const unitPrice = medicine.price;
                    const totalBeforeDiscount = unitPrice * quantity;
                    const discountAmount = (totalBeforeDiscount * discount) / 100;
                    const finalPrice = totalBeforeDiscount - discountAmount;
                    document.getElementById('salePrice').value = unitPrice.toFixed(2);
                    const breakdown = document.getElementById('priceBreakdown');
                    breakdown.innerHTML = `
                        <h4>ğŸ’° Price Breakdown:</h4>
                        <div class="price-item"><span>Unit Price:</span><span>$${unitPrice.toFixed(2)} Ã— ${quantity}</span></div>
                        <div class="price-item"><span>Subtotal:</span><span>$${totalBeforeDiscount.toFixed(2)}</span></div>
                        ${discount > 0 ? `<div class="price-item" style="color: #e74c3c;"><span>Discount (${discount}%):</span><span>- $${discountAmount.toFixed(2)}</span></div>` : ''}
                        <div class="price-item price-total"><span>ğŸ’µ Total Amount:</span><span><strong>$${finalPrice.toFixed(2)}</strong></span></div>
                    `;
                }
            } else {
                document.getElementById('salePrice').value = '';
                document.getElementById('priceBreakdown').innerHTML = '';
            }
        }

        function updateEditSalePrice() {
            const medicineId = document.getElementById('editSaleMedicine').value;
            const quantity = parseInt(document.getElementById('editSaleQuantity').value) || 1;
            const discount = parseFloat(document.getElementById('editSaleDiscount').value) || 0;
            const unitPrice = parseFloat(document.getElementById('editSalePrice').value) || 0;
            if (medicineId) {
                const medicine = db.getMedicines().find(m => m.id === parseInt(medicineId));
                if (medicine && unitPrice === 0) {
                    document.getElementById('editSalePrice').value = medicine.price.toFixed(2);
                    updateEditSalePrice();
                    return;
                }
                const totalBeforeDiscount = unitPrice * quantity;
                const discountAmount = (totalBeforeDiscount * discount) / 100;
                const finalPrice = totalBeforeDiscount - discountAmount;
                const breakdown = document.getElementById('editPriceBreakdown');
                breakdown.innerHTML = `
                    <h4>ğŸ’° Price Breakdown:</h4>
                    <div class="price-item"><span>Unit Price:</span><span>$${unitPrice.toFixed(2)} Ã— ${quantity}</span></div>
                    <div class="price-item"><span>Subtotal:</span><span>$${totalBeforeDiscount.toFixed(2)}</span></div>
                    ${discount > 0 ? `<div class="price-item" style="color: #e74c3c;"><span>Discount (${discount}%):</span><span>- $${discountAmount.toFixed(2)}</span></div>` : ''}
                    <div class="price-item price-total"><span>ğŸ’µ Total Amount:</span><span><strong>$${finalPrice.toFixed(2)}</strong></span></div>
                `;
            } else {
                document.getElementById('editPriceBreakdown').innerHTML = '';
            }
        }

        function recordSale() {
            const medicineId = parseInt(document.getElementById('saleMedicine').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const unitPrice = parseFloat(document.getElementById('salePrice').value);
            if (!medicineId || !quantity || quantity <= 0) {
                showNotification('âŒ Please select a medicine and enter valid quantity!', 'error'); return;
            }
            const medicine = db.getMedicines().find(m => m.id === medicineId);
            if (!medicine) { showNotification('âŒ Medicine not found!', 'error'); return; }
            if (medicine.quantity < quantity) {
                showNotification(`âŒ Insufficient stock! Only ${medicine.quantity} units available.`, 'error'); return;
            }
            if (new Date(medicine.expiry_date) <= new Date()) {
                showNotification('âŒ Cannot sell expired medicine!', 'error'); return;
            }
            const totalBeforeDiscount = unitPrice * quantity;
            const discountAmount = (totalBeforeDiscount * discount) / 100;
            const finalPrice = totalBeforeDiscount - discountAmount;
            const sale = {
                medicine_id: medicineId, quantity: quantity, unit_price: unitPrice, discount: discount,
                discount_amount: discountAmount, total_price: finalPrice, medicine_name: medicine.name,
                batch_number: medicine.batch_number, medicine_image: medicine.image
            };
            db.recordSale(sale);
            clearSaleForm();
            loadSales();
            loadMedicines();
            loadDashboard();
            loadMedicineOptions();
            showNotification('âœ… Sale recorded successfully!', 'success');
        }

        function clearSaleForm() {
            document.getElementById('saleMedicine').value = '';
            document.getElementById('saleQuantity').value = '1';
            document.getElementById('saleDiscount').value = '0';
            document.getElementById('salePrice').value = '';
            document.getElementById('priceBreakdown').innerHTML = '';
        }

        function loadSales() {
            const sales = db.getSales();
            const tbody = document.getElementById('salesTable');
            tbody.innerHTML = '';
            const recentSales = sales.slice(-20).reverse();
            recentSales.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${sale.medicine_name}</strong><br><small>${sale.batch_number}</small></td>
                    <td><img src="${sale.medicine_image}" alt="${sale.medicine_name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyMFY2ME00MCAyMFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                    <td>${sale.quantity}</td>
                    <td>$${parseFloat(sale.unit_price).toFixed(2)}</td>
                    <td>${sale.discount}%</td>
                    <td><strong>$${parseFloat(sale.total_price).toFixed(2)}</strong></td>
                    <td>${new Date(sale.date).toLocaleDateString()}<br><small>${new Date(sale.date).toLocaleTimeString()}</small></td>
                    <td>
                        <button class="btn btn-warning" onclick="editSale(${sale.id})">âœï¸ Edit</button>
                        <button class="btn btn-danger" onclick="deleteSale(${sale.id})">ğŸ—‘ï¸ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editSale(saleId) {
            const sale = db.getSales().find(s => s.id === saleId);
            if (sale) {
                currentEditingSale = sale;
                const modal = document.getElementById('editSaleModal');
                document.getElementById('editSaleMedicine').value = sale.medicine_id;
                document.getElementById('editSaleQuantity').value = sale.quantity;
                document.getElementById('editSaleDiscount').value = sale.discount;
                document.getElementById('editSalePrice').value = sale.unit_price;
                updateEditSalePrice();
                modal.style.display = 'block';
            }
        }

        function closeEditSaleForm() {
            document.getElementById('editSaleModal').style.display = 'none';
            currentEditingSale = null;
        }

        function updateSale() {
            if (!currentEditingSale) return;
            const medicineId = parseInt(document.getElementById('editSaleMedicine').value);
            const quantity = parseInt(document.getElementById('editSaleQuantity').value);
            const discount = parseFloat(document.getElementById('editSaleDiscount').value) || 0;
            const unitPrice = parseFloat(document.getElementById('editSalePrice').value);
            if (!medicineId || !quantity || quantity <= 0) {
                showNotification('âŒ Please select a medicine and enter valid quantity!', 'error'); return;
            }
            const medicine = db.getMedicines().find(m => m.id === medicineId);
            if (!medicine) { showNotification('âŒ Medicine not found!', 'error'); return; }
            const originalSale = currentEditingSale;
            const availableStock = medicine.quantity + (originalSale.medicine_id === medicineId ? originalSale.quantity : 0);
            if (availableStock < quantity) {
                showNotification(`âŒ Insufficient stock! Only ${availableStock} units available.`, 'error'); return;
            }
            if (new Date(medicine.expiry_date) <= new Date()) {
                showNotification('âŒ Cannot sell expired medicine!', 'error'); return;
            }
            const totalBeforeDiscount = unitPrice * quantity;
            const discountAmount = (totalBeforeDiscount * discount) / 100;
            const finalPrice = totalBeforeDiscount - discountAmount;
            const updatedSale = {
                medicine_id: medicineId, quantity: quantity, unit_price: unitPrice, discount: discount,
                discount_amount: discountAmount, total_price: finalPrice, medicine_name: medicine.name,
                batch_number: medicine.batch_number, medicine_image: medicine.image
            };
            if (db.updateSale(currentEditingSale.id, updatedSale)) {
                closeEditSaleForm();
                loadSales();
                loadMedicines();
                loadDashboard();
                showNotification('âœ… Sale updated successfully!', 'success');
            } else {
                showNotification('âŒ Error updating sale!', 'error');
            }
        }

        function deleteSale(saleId) {
            if (confirm('âš ï¸ Are you sure you want to delete this sale record? This action will restore the stock quantity.')) {
                if (db.deleteSale(saleId)) {
                    loadSales();
                    loadMedicines();
                    loadDashboard();
                    showNotification('ğŸ—‘ï¸ Sale deleted successfully! Stock quantity restored.', 'success');
                } else {
                    showNotification('âŒ Error deleting sale!', 'error');
                }
            }
        }

        function loadReports() {
            document.getElementById('reportsOutput').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">ğŸ“Š Analytics & Reports Dashboard</h3>
                    <p style="color: #7f8c8d; margin-bottom: 30px;">Select a report type to generate detailed analytics and insights about your medicine inventory and sales performance.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 25px; border-radius: 10px; text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">â°</div><h4>Expiry Report</h4><p>Track expired and expiring medicines</p></div>
                        <div style="background: linear-gradient(135deg, #27ae60, #219a52); color: white; padding: 25px; border-radius: 10px; text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">ğŸ“¦</div><h4>Stock Report</h4><p>Monitor inventory levels</p></div>
                        <div style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 25px; border-radius: 10px; text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">ğŸ’°</div><h4>Sales Report</h4><p>Analyze sales performance</p></div>
                        <div style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 25px; border-radius: 10px; text-align: center;"><div style="font-size: 2em; margin-bottom: 10px;">ğŸ¯</div><h4>Discount Analysis</h4><p>Review discount patterns</p></div>
                    </div>
                </div>
            `;
        }

        function generateExpiryReport() {
            const medicines = db.getMedicines();
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expired = medicines.filter(m => new Date(m.expiry_date) <= now);
            const expiringSoon = medicines.filter(m => { const expiry = new Date(m.expiry_date); return expiry > now && expiry <= thirtyDaysFromNow; });
            let reportHTML = '<h3 style="color: #2c3e50; margin-bottom: 25px;">â° Expiry Report</h3>';
            if (expired.length > 0) {
                reportHTML += '<h4 style="color: #e74c3c; margin: 25px 0 15px 0;">ğŸš¨ Expired Medicines - IMMEDIATE ACTION REQUIRED</h4>';
                reportHTML += '<table><tr><th>ğŸ–¼ï¸ Image</th><th>ğŸ’Š Name</th><th>ğŸ·ï¸ Batch</th><th>ğŸ“… Expiry Date</th><th>ğŸ“¦ Quantity</th><th>ğŸš¨ Action Required</th></tr>';
                expired.forEach(med => {
                    reportHTML += `<tr>
                        <td><img src="${med.image}" alt="${med.name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyMFY2ME00MCAyMFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                        <td><strong>${med.name}</strong></td><td>${med.batch_number}</td><td>${new Date(med.expiry_date).toLocaleDateString()}</td><td>${med.quantity}</td>
                        <td><strong style="color: #e74c3c;">REMOVE FROM SHELF</strong></td></tr>`;
                });
                reportHTML += '</table>';
            }
            if (expiringSoon.length > 0) {
                reportHTML += '<h4 style="color: #f39c12; margin: 30px 0 15px 0;">âš ï¸ Medicines Expiring Soon (Next 30 Days)</h4>';
                reportHTML += '<table><tr><th>ğŸ–¼ï¸ Image</th><th>ğŸ’Š Name</th><th>ğŸ·ï¸ Batch</th><th>ğŸ“… Expiry Date</th><th>ğŸ“¦ Quantity</th><th>â° Days Left</th></tr>';
                expiringSoon.forEach(med => {
                    const daysLeft = Math.ceil((new Date(med.expiry_date) - now) / (1000 * 60 * 60 * 24));
                    reportHTML += `<tr>
                        <td><img src="${med.image}" alt="${med.name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyMFY2ME00MCAyAFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                        <td><strong>${med.name}</strong></td><td>${med.batch_number}</td><td>${new Date(med.expiry_date).toLocaleDateString()}</td><td>${med.quantity}</td><td><strong>${daysLeft} days</strong></td></tr>`;
                });
                reportHTML += '</table>';
            }
            if (expired.length === 0 && expiringSoon.length === 0) {
                reportHTML += '<div style="text-align: center; padding: 40px; background: #d4edda; border-radius: 10px; color: #155724;"><h4 style="color: #155724;">âœ… No Expiry Issues Found</h4><p>All medicines are within safe dates and properly managed.</p></div>';
            }
            document.getElementById('reportsOutput').innerHTML = reportHTML;
        }

        function generateStockReport() {
            const medicines = db.getMedicines();
            const lowStock = medicines.filter(m => m.quantity <= m.min_stock);
            let reportHTML = '<h3 style="color: #2c3e50; margin-bottom: 25px;">ğŸ“¦ Stock Report</h3>';
            if (lowStock.length > 0) {
                reportHTML += '<h4 style="color: #f39c12; margin: 25px 0 15px 0;">ğŸ“‰ Low Stock Medicines - REORDER NEEDED</h4>';
                reportHTML += '<table><tr><th>ğŸ–¼ï¸ Image</th><th>ğŸ’Š Name</th><th>ğŸ·ï¸ Batch</th><th>ğŸ“¦ Current Stock</th><th>âš¡ Minimum Stock</th><th>ğŸš¨ Status</th></tr>';
                lowStock.forEach(med => {
                    reportHTML += `<tr>
                        <td><img src="${med.image}" alt="${med.name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyAFY2ME00MCAyAFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                        <td><strong>${med.name}</strong></td><td>${med.batch_number}</td><td>${med.quantity}</td><td>${med.min_stock}</td>
                        <td><strong style="color: #f39c12;">REORDER NEEDED</strong></td></tr>`;
                });
                reportHTML += '</table>';
            } else {
                reportHTML += '<div style="text-align: center; padding: 30px; background: #d4edda; border-radius: 10px; color: #155724; margin: 20px 0;"><h4 style="color: #155724;">âœ… All Medicines Have Sufficient Stock</h4><p>No low stock items detected. Inventory levels are optimal.</p></div>';
            }
            reportHTML += '<h4 style="color: #2c3e50; margin: 30px 0 15px 0;">ğŸ“Š Complete Stock Overview</h4>';
            reportHTML += '<table><tr><th>ğŸ–¼ï¸ Image</th><th>ğŸ’Š Name</th><th>ğŸ·ï¸ Batch</th><th>ğŸ“¦ Current Stock</th><th>âš¡ Minimum Stock</th><th>ğŸ“Š Status</th></tr>';
            medicines.forEach(med => {
                const status = getMedicineStatus(med);
                reportHTML += `<tr>
                    <td><img src="${med.image}" alt="${med.name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyAFY2ME00MCAyAFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                    <td><strong>${med.name}</strong></td><td>${med.batch_number}</td><td>${med.quantity}</td><td>${med.min_stock}</td>
                    <td><span class="status-badge status-${status}">${status.replace('_', ' ').toUpperCase()}</span></td></tr>`;
            });
            reportHTML += '</table>';
            document.getElementById('reportsOutput').innerHTML = reportHTML;
        }

        function generateSalesReport() {
            const sales = db.getSales();
            const recentSales = sales.slice(-20).reverse();
            let reportHTML = '<h3 style="color: #2c3e50; margin-bottom: 25px;">ğŸ’° Sales Report</h3>';
            if (recentSales.length > 0) {
                reportHTML += '<h4 style="color: #2c3e50; margin: 25px 0 15px 0;">ğŸ“‹ Recent Sales (Last 20 Transactions)</h4>';
                reportHTML += '<table><tr><th>ğŸ’Š Medicine</th><th>ğŸ–¼ï¸ Image</th><th>ğŸ“¦ Quantity</th><th>ğŸ’° Unit Price</th><th>ğŸ¯ Discount</th><th>ğŸ’µ Total</th><th>ğŸ“… Date</th></tr>';
                let totalRevenue = 0; let totalDiscounts = 0;
                recentSales.forEach(sale => {
                    totalRevenue += sale.total_price; totalDiscounts += sale.discount_amount || 0;
                    reportHTML += `<tr>
                        <td><strong>${sale.medicine_name}</strong><br><small>${sale.batch_number}</small></td>
                        <td><img src="${sale.medicine_image}" alt="${sale.medicine_name}" class="medicine-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcwIiBoZWlnaHQ9IjcwIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik0yMCAzMEg1MFY1MEgyMFYzMFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMCAyAFY2ME00MCAyAFY2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPgo='"></td>
                        <td>${sale.quantity}</td><td>$${sale.unit_price.toFixed(2)}</td><td>${sale.discount}%</td><td><strong>$${parseFloat(sale.total_price).toFixed(2)}</strong></td>
                        <td>${new Date(sale.date).toLocaleDateString()}<br><small>${new Date(sale.date).toLocaleTimeString()}</small></td></tr>`;
                });
                reportHTML += '</table>';
                reportHTML += `<div class="sales-summary"><h4>ğŸ’° Sales Summary</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">$${totalRevenue.toFixed(2)}</div><div>Total Revenue</div></div>
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">$${totalDiscounts.toFixed(2)}</div><div>Total Discounts Given</div></div>
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">$${(totalRevenue + totalDiscounts).toFixed(2)}</div><div>Gross Revenue</div></div>
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">${((totalDiscounts / (totalRevenue + totalDiscounts)) * 100).toFixed(1)}%</div><div>Average Discount Rate</div></div></div></div>`;
            } else {
                reportHTML += '<div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 10px; color: #856404;"><h4 style="color: #856404;">ğŸ“Š No Sales Recorded Yet</h4><p>Start recording sales to see analytics and reports here.</p></div>';
            }
            document.getElementById('reportsOutput').innerHTML = reportHTML;
        }

        function generateDiscountReport() {
            const sales = db.getSales();
            const discountedSales = sales.filter(s => s.discount > 0);
            const totalSales = sales.length;
            let reportHTML = '<h3 style="color: #2c3e50; margin-bottom: 25px;">ğŸ¯ Discount Analysis Report</h3>';
            if (totalSales > 0) {
                const discountRanges = { '0%': sales.filter(s => s.discount === 0).length, '1-10%': sales.filter(s => s.discount > 0 && s.discount <= 10).length, '11-20%': sales.filter(s => s.discount > 10 && s.discount <= 20).length, '21-30%': sales.filter(s => s.discount > 20 && s.discount <= 30).length, '31%+': sales.filter(s => s.discount > 30).length };
                const totalDiscountAmount = sales.reduce((sum, sale) => sum + (sale.discount_amount || 0), 0);
                const totalSalesValue = sales.reduce((sum, sale) => sum + sale.total_price, 0) + totalDiscountAmount;
                const averageDiscount = totalSales > 0 ? (totalDiscountAmount / totalSalesValue * 100) : 0;
                reportHTML += `<div class="sales-summary"><h4>ğŸ“Š Discount Overview</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">${totalSales}</div><div>Total Sales</div></div>
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">${discountedSales.length}</div><div>Discounted Sales</div></div>
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">$${totalDiscountAmount.toFixed(2)}</div><div>Total Discounts</div></div>
                    <div style="text-align: center;"><div style="font-size: 1.5em; font-weight: bold;">${averageDiscount.toFixed(1)}%</div><div>Avg Discount Rate</div></div></div></div>`;
                reportHTML += '<h4 style="color: #2c3e50; margin: 30px 0 15px 0;">ğŸ“ˆ Discount Distribution</h4><table><tr><th>ğŸ¯ Discount Range</th><th>ğŸ“Š Number of Sales</th><th>ğŸ“ˆ Percentage</th></tr>';
                Object.entries(discountRanges).forEach(([range, count]) => {
                    const percentage = totalSales > 0 ? (count / totalSales * 100).toFixed(1) : '0.0';
                    reportHTML += `<tr><td>${range}</td><td>${count}</td><td>${percentage}%</td></tr>`;
                });
                reportHTML += '</table>';
                if (discountedSales.length > 0) {
                    reportHTML += '<h4 style="color: #2c3e50; margin: 30px 0 15px 0;">ğŸ† Top Discounted Sales</h4><table><tr><th>ğŸ’Š Medicine</th><th>ğŸ¯ Discount</th><th>ğŸ’° Discount Amount</th><th>ğŸ’µ Final Price</th><th>ğŸ“… Date</th></tr>';
                    discountedSales.sort((a, b) => b.discount - a.discount).slice(0, 10).forEach(sale => {
                        reportHTML += `<tr><td><strong>${sale.medicine_name}</strong></td><td><strong>${sale.discount}%</strong></td><td>$${(sale.discount_amount || 0).toFixed(2)}</td><td>$${sale.total_price.toFixed(2)}</td><td>${new Date(sale.date).toLocaleDateString()}</td></tr>`;
                    });
                    reportHTML += '</table>';
                }
            } else {
                reportHTML += '<div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 10px; color: #856404;"><h4 style="color: #856404;">ğŸ“Š No Sales Data Available</h4><p>Record some sales to see discount analytics and patterns.</p></div>';
            }
            document.getElementById('reportsOutput').innerHTML = reportHTML;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expiryDate').min = today;
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>